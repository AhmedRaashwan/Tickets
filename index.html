<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Handball Tickets</title>
<style>
  body { font-family: Arial, sans-serif; margin:20px; background:#f4f4f4; color:#333; }
  h1 { text-align:center; }
  .container { max-width:800px; margin:0 auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
  label { display:block; margin-top:15px; font-weight:bold; }
  select, input { width:100%; padding:8px; margin-top:5px; border-radius:5px; border:1px solid #ccc; }
  button { margin-top:20px; padding:10px 20px; border:none; border-radius:5px; background:#007bff; color:#fff; font-size:16px; cursor:pointer; }
  button:disabled { background:#999; cursor:not-allowed; }
  #availableMsg, #resultMsg { margin-top:10px; padding:10px; border-radius:5px; }
  #availableMsg { background:#e0f7e0; color:#2d7a2d; display:none; }
  #resultMsg { display:none; background:#f0f0f0; }
  #prepareLoading, #logLoading { display:none; margin-left:10px; }
  #logPanel { margin-top:20px; max-height:200px; overflow:auto; background:#fafafa; padding:10px; border:1px solid #ccc; border-radius:5px; font-size:14px; }
  .lang-toggle { float:right; margin-top:-40px; cursor:pointer; color:#007bff; text-decoration:underline; }
</style>
</head>
<body class="en">
<div class="container">
  <span class="lang-toggle" onclick="toggleLang()">AR/EN</span>
  <h1>Handball Tickets</h1>

  <label for="category">Category</label>
  <select id="category" onchange="loadDates()"></select>

  <label for="dateFolder">Date</label>
  <select id="dateFolder" onchange="updateAvailable()"></select>

  <label for="requester">Requester</label>
  <select id="requester">
    <option value="">Select Requester</option>
    <option value="قايد">قايد</option>
    <option value="مشعل">مشعل</option>
    <option value="حسن">حسن</option>
    <option value="المطوع">المطوع</option>
    <option value="فيصل">فيصل</option>
    <option value="رشوان">رشوان</option>
    <option value="الملا">الملا</option>
  </select>

  <label for="count">Number of Tickets</label>
  <input type="number" id="count" min="1" value="1">

  <button id="prepareBtn" onclick="prepareTickets()">
    <span id="btnText">Prepare Tickets</span>
    <span id="prepareLoading">⏳</span>
  </button>

  <div id="availableMsg"></div>
  <div id="resultMsg"></div>

  <h3>Log</h3>
  <span id="logLoading">⏳ Loading log...</span>
  <div id="logPanel"></div>
</div>

<script>
// --- Worker URL ---
const WORKER_URL = 'https://YOUR_WORKER_SUBDOMAIN.workers.dev';

// --- Language Data ---
const langData = {
  en: {
    available: 'Available Tickets: ',
    processing: 'Processing...',
    prepare: 'Prepare Tickets',
    noLog: 'No log available.'
  },
  ar: {
    available: 'التذاكر المتاحة: ',
    processing: 'جاري المعالجة...',
    prepare: 'تحضير التذاكر',
    noLog: 'لا يوجد سجل.'
  }
};

// --- Load Categories ---
function loadCategories() {
  fetch(`${WORKER_URL}?action=getCategories`)
    .then(res => res.json())
    .then(categories => {
      categories.sort((a,b) => a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));
      const sel = document.getElementById('category');
      sel.innerHTML = '<option value="">Select Category</option>';
      categories.forEach(c => { 
        const opt = document.createElement('option'); 
        opt.value = c.id; 
        opt.text = c.name; 
        sel.appendChild(opt); 
      });
      loadSummary();
    })
    .catch(err => console.error(err));
}

// --- Load Dates ---
function loadDates() {
  const catId = document.getElementById('category').value;
  const sel = document.getElementById('dateFolder'); 
  sel.innerHTML = '<option value="">Select Date</option>';
  document.getElementById('availableMsg').style.display = 'none';
  if(!catId) return;

  fetch(`${WORKER_URL}?action=getDateFolders&categoryId=${catId}`)
    .then(res => res.json())
    .then(dates => {
      dates.filter(d => d.available > 0).forEach(d => { 
        const opt = document.createElement('option'); 
        opt.value = d.id; 
        opt.text = `${d.name} (Available: ${d.available})`; 
        sel.appendChild(opt); 
      });
      updateAvailable(); 
      loadSummary();
    })
    .catch(err => console.error(err));
}

// --- Update Available ---
function updateAvailable() {
  const dateId = document.getElementById('dateFolder').value;
  const lang = document.body.classList.contains('ar') ? 'ar' : 'en';
  if(!dateId) {
    document.getElementById('availableMsg').style.display = 'none';
    return;
  }

  fetch(`${WORKER_URL}?action=getAvailableTickets&dateFolderId=${dateId}`)
    .then(res => res.text())
    .then(av => {
      document.getElementById('availableMsg').style.display = 'block';
      document.getElementById('availableMsg').innerHTML = `✓ ${langData[lang].available}${av}`;
    })
    .catch(err => console.error(err));
}

// --- Prepare Tickets ---
function prepareTickets() {
  const requester = document.getElementById('requester').value;
  const catId = document.getElementById('category').value;
  const dateId = document.getElementById('dateFolder').value;
  const count = parseInt(document.getElementById('count').value);

  if(!requester || !catId || !dateId || !count || count < 1){ 
    alert('Please fill all fields with valid values.'); 
    return; 
  }

  const btn = document.getElementById('prepareBtn');
  const btnText = document.getElementById('btnText');
  const lang = document.body.classList.contains('ar') ? 'ar' : 'en';
  
  btn.disabled = true;
  btnText.textContent = langData[lang].processing;
  document.getElementById('prepareLoading').style.display = 'inline-block';
  document.getElementById('resultMsg').style.display = 'block';
  document.getElementById('resultMsg').innerHTML = langData[lang].processing;

  fetch(WORKER_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action:'prepareTickets', categoryId: catId, dateFolderId: dateId, requester, count })
  })
  .then(res => res.json())
  .then(res => {
    btn.disabled = false;
    btnText.textContent = langData[lang].prepare;
    document.getElementById('prepareLoading').style.display = 'none';
    
    if(res.success){
      document.getElementById('resultMsg').innerHTML = `✅ ${res.message}<br><a href="${res.zipUrl}" target="_blank">⬇️ Download ZIP</a>`;
      updateAvailable(); 
      loadDates();
      loadLog();
      launchConfetti();
    } else {
      document.getElementById('resultMsg').innerHTML = `❌ ${res.message}`;
    }
  })
  .catch(err => {
    btn.disabled = false;
    btnText.textContent = langData[lang].prepare;
    document.getElementById('prepareLoading').style.display = 'none';
    document.getElementById('resultMsg').style.display = 'block';
    document.getElementById('resultMsg').innerHTML = '❌ Error: ' + err;
    console.error(err);
  });
}

// --- Load Log ---
function loadLog() {
  document.getElementById('logLoading').style.display = 'inline-block';
  fetch(`${WORKER_URL}?action=getLogFile`)
    .then(res => res.text())
    .then(data => {
      const panel = document.getElementById('logPanel');
      const lang = document.body.classList.contains('ar') ? 'ar' : 'en';
      if (!data || data.trim() === '') {
        panel.innerHTML = `<div style="text-align:center; color:#999;">${langData[lang].noLog}</div>`;
      } else {
        panel.innerHTML = '';
        const lines = data.split('\n').filter(line => line.trim() !== '');
        lines.reverse().forEach(line => {
          const div = document.createElement('div');
          div.textContent = line;
          panel.appendChild(div);
        });
      }
      document.getElementById('logLoading').style.display = 'none';
    })
    .catch(err => {
      console.error('Error loading log:', err);
      document.getElementById('logPanel').innerHTML = '<div style="color:#e74c3c;">Error loading log file.</div>';
      document.getElementById('logLoading').style.display = 'none';
    });
}

// --- Language Toggle ---
function toggleLang() {
  if(document.body.classList.contains('ar')){
    document.body.classList.remove('ar');
    document.body.classList.add('en');
  } else {
    document.body.classList.remove('en');
    document.body.classList.add('ar');
  }
  loadCategories();
  loadLog();
  updateAvailable();
}

// --- Confetti ---
function launchConfetti() {
  const duration = 2 * 1000;
  const end = Date.now() + duration;
  (function frame() {
    confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 } });
    confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 } });
    if(Date.now() < end) requestAnimationFrame(frame);
  })();
}

// --- Init ---
window.onload = () => {
  loadCategories();
  loadLog();
};
</script>

<!-- Confetti CDN -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</body>
</html>
